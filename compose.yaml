services:
  spicedb:
    image: authzed/spicedb:v1.48.0
    command: "serve"
    env_file:
      - env/spicedb.env
    ports:
      - "50051:50051"
    networks:
      - kartograph
    restart: unless-stopped
    environment:
      - "SPICEDB_DATASTORE_ENGINE=postgres"
      - "SPICEDB_GRPC_TLS_CERT_PATH=/etc/spicedb/tls/cert.pem"
      - "SPICEDB_GRPC_TLS_KEY_PATH=/etc/spicedb/tls/key.pem"
    volumes:
      - ./certs/spicedb-cert.pem:/etc/spicedb/tls/cert.pem:ro
      - ./certs/spicedb-key.pem:/etc/spicedb/tls/key.pem:ro
    depends_on:
      spicedb-migrate:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=:50051", "-tls", "-tls-no-verify"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  spicedb-migrate:
    image: "authzed/spicedb"
    command: "migrate head"
    restart: "on-failure"
    networks:
      - kartograph
    env_file:
      - env/spicedb.env
    environment:
      - "SPICEDB_DATASTORE_ENGINE=postgres"
    depends_on:
      db-init:
        condition: service_completed_successfully

  # Transient service to ensure the 'spicedb' database exists
  db-init:
    image: postgres:17-alpine
    networks:
      - kartograph
    env_file:
      - env/postgres.env
    command: >
      sh -c "
      PGPASSWORD=$${POSTGRES_PASSWORD} psql -h postgres -U $${POSTGRES_USER} -d postgres -tc \"SELECT 1 FROM pg_database WHERE datname = 'spicedb'\" | grep -q 1 || 
      PGPASSWORD=$${POSTGRES_PASSWORD} psql -h postgres -U $${POSTGRES_USER} -d postgres -c \"CREATE DATABASE spicedb;\"
      "
    depends_on:
      postgres:
        condition: service_healthy

  postgres:
    image: apache/age:release_PG17_1.6.0
    env_file:
      - env/postgres.env
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - kartograph
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kartograph"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Init service: Run Alembic database migrations
  db-migrate:
    build:
      context: ./src/api
      dockerfile: Dockerfile
    env_file:
      - env/api.env
    networks:
      - kartograph
    command: ["uv", "run", "alembic", "upgrade", "head"]
    restart: "on-failure"
    depends_on:
      postgres:
        condition: service_healthy

  # Init service: Load SpiceDB authorization schema
  spicedb-schema-init:
    image: authzed/zed:latest
    networks:
      - kartograph
    volumes:
      - ./src/api/shared_kernel/authorization/spicedb/schema.zed:/schema/schema.zed:ro
      - ./certs/spicedb-cert.pem:/etc/ssl/certs/spicedb.pem:ro
    command: ["schema", "write", "--skip-verify", "/schema/schema.zed"]
    environment:
      - ZED_ENDPOINT=spicedb:50051
      - ZED_TOKEN=${SPICEDB_PRESHARED_KEY:-changeme}
    restart: "on-failure"
    depends_on:
      spicedb:
        condition: service_healthy

  api:
    build:
      context: ./src/api
      dockerfile: Dockerfile
    env_file:
      - env/api.env
    ports:
      - "8000:8000"
    networks:
      - kartograph
    volumes:
      - ./certs/spicedb-cert.pem:/etc/ssl/certs/spicedb.pem:ro
    environment:
      - GRPC_DEFAULT_SSL_ROOTS_FILE_PATH=/etc/ssl/certs/spicedb.pem
    depends_on:
      postgres:
        condition: service_healthy
      db-migrate:
        condition: service_completed_successfully
      spicedb-schema-init:
        condition: service_completed_successfully
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000/health').read()",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

networks:
  kartograph:
    driver: bridge

volumes:
  postgres_data:
