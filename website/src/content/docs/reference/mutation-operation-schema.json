{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://kartograph.dev/schemas/mutation-operation.json",
  "title": "MutationOperation",
  "description": "Mutation operation for the Graph bounded context. Defines the contract between Extraction and Graph contexts.",
  "type": "object",
  "required": ["op", "type"],
  "properties": {
    "op": {
      "type": "string",
      "enum": ["DEFINE", "CREATE", "UPDATE", "DELETE"],
      "description": "The operation type: DEFINE (declare entity/relationship type schema), CREATE (idempotent using MERGE), UPDATE (partial update), DELETE (cascade edges with DETACH DELETE)"
    },
    "type": {
      "type": "string",
      "enum": ["node", "edge"],
      "description": "The entity type being mutated"
    },
    "id": {
      "type": "string",
      "description": "Deterministic ID for the entity, generated by the Extraction context using SHA256. Format: {lowercase_type}:{16_hex_chars}. Type prefix is normalized to lowercase. Required for CREATE, UPDATE, and DELETE operations. Not used for DEFINE operations.",
      "minLength": 1,
      "pattern": "^[a-z_]+:[0-9a-f]{16}$",
      "examples": ["person:1a2b3c4d5e6f7890", "knows:9f8e7d6c5b4a3210"]
    },
    "label": {
      "type": "string",
      "description": "The graph label (node type or edge type). Required for CREATE operations.",
      "minLength": 1,
      "examples": ["Person", "Repository", "KNOWS", "WORKS_ON"]
    },
    "start_id": {
      "type": "string",
      "description": "The ID of the start node for an edge. Required for CREATE edge operations. Format: {lowercase_type}:{16_hex_chars}",
      "minLength": 1,
      "pattern": "^[a-z_]+:[0-9a-f]{16}$"
    },
    "end_id": {
      "type": "string",
      "description": "The ID of the end node for an edge. Required for CREATE edge operations. Format: {lowercase_type}:{16_hex_chars}",
      "minLength": 1,
      "pattern": "^[a-z_]+:[0-9a-f]{16}$"
    },
    "set_properties": {
      "type": "object",
      "description": "Properties to set or update. Required for CREATE, optional for UPDATE.",
      "additionalProperties": true,
      "examples": [
        {
          "slug": "alice-smith",
          "name": "Alice Smith",
          "data_source_id": "ds-456",
          "source_path": "people/alice.md"
        }
      ]
    },
    "remove_properties": {
      "type": "array",
      "description": "Property names to remove. Only valid for UPDATE operations.",
      "items": {
        "type": "string",
        "minLength": 1
      },
      "uniqueItems": true,
      "examples": [["middle_name", "old_field"]]
    },
    "description": {
      "type": "string",
      "description": "Plain-text description of what this entity/relationship type is and when to use it. Required for DEFINE operations.",
      "minLength": 1,
      "examples": ["A person entity representing an individual contributor, maintainer, or team member"]
    },
    "example_file_path": {
      "type": "string",
      "description": "Example file path where this type is typically found. Required for DEFINE operations.",
      "minLength": 1,
      "examples": ["people/alice-smith.md", "MAINTAINERS.md"]
    },
    "example_in_file_path": {
      "type": "string",
      "description": "An actual example instance of this type as it appears in the example_file_path. Shows what the extracted data looks like. Required for DEFINE operations.",
      "minLength": 1,
      "examples": ["# Alice Smith\\n\\nSoftware Engineer at Acme Corp\\nEmail: alice@example.com\\nGitHub: @asmith"]
    },
    "required_properties": {
      "type": "array",
      "description": "List of property names that must be present on all instances of this type. Required for DEFINE operations.",
      "items": {
        "type": "string",
        "minLength": 1
      },
      "uniqueItems": true,
      "examples": [["slug", "name"]]
    },
    "optional_properties": {
      "type": "array",
      "description": "List of property names that may be present on instances of this type. Optional for DEFINE operations.",
      "items": {
        "type": "string",
        "minLength": 1
      },
      "uniqueItems": true,
      "examples": [["email", "github_username", "avatar_url"]]
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "op": {"const": "DEFINE"}
        }
      },
      "then": {
        "required": ["label", "description", "example_file_path", "example_in_file_path", "required_properties"],
        "not": {
          "anyOf": [
            {"required": ["id"]},
            {"required": ["set_properties"]},
            {"required": ["remove_properties"]},
            {"required": ["start_id"]},
            {"required": ["end_id"]}
          ]
        },
        "errorMessage": "DEFINE requires 'label', 'description', 'example_file_path', 'example_in_file_path', and 'required_properties'. Cannot include id, set_properties, remove_properties, start_id, or end_id."
      }
    },
    {
      "if": {
        "properties": {
          "op": {"const": "CREATE"}
        }
      },
      "then": {
        "required": ["id", "label", "set_properties"],
        "properties": {
          "set_properties": {
            "type": "object",
            "required": ["data_source_id", "source_path"],
            "properties": {
              "data_source_id": {
                "type": "string",
                "description": "The data source ID for security scoping",
                "minLength": 1
              },
              "source_path": {
                "type": "string",
                "description": "The source file path this entity came from",
                "minLength": 1
              }
            }
          }
        },
        "errorMessage": "CREATE requires 'label' and 'set_properties' with 'data_source_id' and 'source_path'"
      }
    },
    {
      "if": {
        "properties": {
          "op": {"const": "CREATE"},
          "type": {"const": "node"}
        }
      },
      "then": {
        "properties": {
          "set_properties": {
            "type": "object",
            "required": ["data_source_id", "source_path", "slug"],
            "properties": {
              "data_source_id": {
                "type": "string",
                "description": "The data source ID for security scoping",
                "minLength": 1
              },
              "source_path": {
                "type": "string",
                "description": "The source file path this entity came from",
                "minLength": 1
              },
              "slug": {
                "type": "string",
                "description": "The unique slug identifier for this node",
                "minLength": 1
              }
            }
          }
        },
        "errorMessage": "CREATE node requires 'set_properties' with 'data_source_id', 'source_path', and 'slug'"
      }
    },
    {
      "if": {
        "properties": {
          "op": {"const": "CREATE"},
          "type": {"const": "edge"}
        }
      },
      "then": {
        "required": ["start_id", "end_id"],
        "errorMessage": "CREATE edge requires 'start_id' and 'end_id'"
      }
    },
    {
      "if": {
        "properties": {
          "op": {"const": "UPDATE"}
        }
      },
      "then": {
        "required": ["id"],
        "anyOf": [
          {"required": ["set_properties"]},
          {"required": ["remove_properties"]}
        ],
        "errorMessage": "UPDATE requires 'id' and at least one of 'set_properties' or 'remove_properties'"
      }
    },
    {
      "if": {
        "properties": {
          "op": {"const": "DELETE"}
        }
      },
      "then": {
        "required": ["id"],
        "not": {
          "anyOf": [
            {"required": ["set_properties"]},
            {"required": ["remove_properties"]},
            {"required": ["label"]},
            {"required": ["start_id"]},
            {"required": ["end_id"]}
          ]
        },
        "errorMessage": "DELETE requires 'id' and only 'op', 'type', and 'id'"
      }
    }
  ],
  "examples": [
    {
      "op": "DEFINE",
      "type": "node",
      "label": "Person",
      "description": "A person entity representing an individual contributor, maintainer, or team member. Extracted from MAINTAINERS.md, git commit authors, @-mentions in pull requests, and people/ directory markdown files.",
      "example_file_path": "people/alice-smith.md",
      "example_in_file_path": "---\nname: Alice Smith\nemail: alice@example.com\ngithub: asmith\nrole: Senior Engineer\n---\n\n# Alice Smith\n\nAlice is a senior engineer focusing on backend systems.",
      "required_properties": ["slug", "name"],
      "optional_properties": ["email", "github_username", "avatar_url", "role"]
    },
    {
      "op": "DEFINE",
      "type": "edge",
      "label": "KNOWS",
      "description": "Represents a professional relationship or acquaintance between two people, typically colleagues or collaborators. Extracted from co-authorship on pull requests, shared repository maintainership, or explicit mentions in people profiles.",
      "example_file_path": "people/alice-smith.md",
      "example_in_file_path": "## Colleagues\n\n- [@bob-jones](../people/bob-jones.md) - worked together since 2020\n- [@charlie-wilson](../people/charlie-wilson.md) - collaborated on Project X",
      "required_properties": ["since"],
      "optional_properties": ["context", "confidence"]
    },
    {
      "op": "CREATE",
      "type": "node",
      "id": "person:1a2b3c4d5e6f7890",
      "label": "Person",
      "set_properties": {
        "slug": "alice-smith",
        "name": "Alice Smith",
        "email": "alice@example.com",
        "data_source_id": "ds-456",
        "source_path": "people/alice.md"
      }
    },
    {
      "op": "CREATE",
      "type": "edge",
      "id": "knows:9f8e7d6c5b4a3210",
      "label": "KNOWS",
      "start_id": "person:1a2b3c4d5e6f7890",
      "end_id": "person:abcdef0123456789",
      "set_properties": {
        "since": 2020,
        "context": "colleagues",
        "data_source_id": "ds-456",
        "source_path": "people/alice.md"
      }
    },
    {
      "op": "UPDATE",
      "type": "node",
      "id": "person:1a2b3c4d5e6f7890",
      "set_properties": {
        "name": "Alice Updated",
        "email": "alice.updated@example.com"
      }
    },
    {
      "op": "UPDATE",
      "type": "node",
      "id": "person:1a2b3c4d5e6f7890",
      "remove_properties": ["middle_name", "old_email"]
    },
    {
      "op": "UPDATE",
      "type": "node",
      "id": "person:1a2b3c4d5e6f7890",
      "set_properties": {
        "name": "Alice Smith"
      },
      "remove_properties": ["nickname"]
    },
    {
      "op": "DELETE",
      "type": "node",
      "id": "person:fedcba9876543210"
    },
    {
      "op": "DELETE",
      "type": "edge",
      "id": "knows:0123456789abcdef"
    }
  ]
}
